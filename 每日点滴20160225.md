## 每日点滴20160225

### 问题

中文站目前使用了s.cn.made-in-china.com的域名访问静态资源，杨芃说要换成新的域名，这样效率更高

### 问题分析

知道换域名可以提高效率，但是不知道子域名算不算换域名，知其然不知其所以然

上知乎搜索了下，有很多相关的答案，也是收益颇丰

https://www.zhihu.com/question/20534662

总结了两个原因：

1. cookie free

	当浏览器向服务器请求一个静态资源时,会先发送同域名下的 cookie，服务器对于这些 cookie 不会做任何处理。因此它们只是在毫无意义的消耗带宽。所以你应该确保对于静态内容的请求是无coockie的请求。

   	如果给 http://126.com 设置了cookie,那么会感染所有子域名, 请求 http://www.126.com/logo.gif或者http://image.126.com/logo.gif 时便会带上讨厌的cookie。
	
	所以要用单独的域名，以减少请求，提高网页性能。


2. 浏览器并发请求资源数限制 domain hash

	浏览器对每个域名的并发链接是有限制的，使用多个独立域名，可以大大拓展这个并发连接数。也就是令浏览器并行下载更多资源，提高站点性能。

网上查了一下，子域名也算不同的域名，所以使用子域名也可以解决浏览器的并发请求资源数的问题，如果设置cookie的时候不设置到主域名下，那么使用子域名cookie污染的问题也可以解决。

https://www.zhihu.com/question/20474326

上面这个帖子，从前后端两个方向讨论了浏览器并发请求资源数限制的原因

前端方面：

首先，是基于端口数量和线程切换开销的考虑，浏览器不可能无限量的并发请求，因此衍生出来了并发限制和HTTP/1.1的Keep alive。 所以，IE6/7在HTTP/1.1下的并发才2，但HTTP/1.0却是4。 而随着技术的发展，负载均衡和各类NoSQL的大量应用，基本已经足以应对C10K的问题。 但却并不是每个网站都懂得利用domain hash也就是多域名来加速访问。因此，新的浏览器加大了并发数的限制，但却仍控制在8以内。

后端方面：

罗列一下浏览器这么决定可能有什么考虑

1. 由于TCP协议的限制，PC 端只有65536个端口可用以向外部发出连接，而操作系统对半开连接数也有限制以保护操作系统的 TCP\IP 协议栈资源不被迅速耗尽，因此浏览器不好发出太多的 TCP 连接，而是采取用完了之后再重复利用 TCP 连接或者干脆重新建立 TCP 连接的方法。

2. 如果采用阻塞的套接字模型来建立连接，同时发出多个连接会导致浏览器不得不多开几个线程，而线程有时候算不得是轻量级资源，毕竟做一次上下文切换开销不小。

3. 这是浏览器作为一个有良知的客户端在保护服务器。就像以太网的冲突检测机制，客户端在使用公共资源的时候必须要自行决定一个等待期。当超过2个客户端要使用公共资源时，强势的那个邪恶的客户端可能会导致弱势的客户端完全无法访问公共资源。从前迅雷被喷就是因为它不是一个有良知的客户端，它作为 HTTP 协议客户端没有考虑到服务器的压力，作为 BT 客户端没有考虑到自己回馈上传量的义务。

补充：半开连接指的是 TCP 连接的一种状态，当客户端向服务器端发出一个 TCP 连接请求，在客户端还没收到服务器端的回应并发回一个确认的数据包时，这个 TCP 连接就是一个半开连接。若服务器到超时以后仍无响应，那么这个 TCP 连接就等于白费了，所以操作系统会本能的保护自己，限制 TCP 半开连接的总个数，以免有限的内核态内存空间被维护 TCP 连接所需的内存所浪费。

### 问题解决

通过分析，可得出结论，理论上来说，使用子域名的方式也是可行的

1. 子域名也算是不同的域名，所以可以解决浏览器并发请求资源数的问题
2. 只要是在设置cookie的时候，不要将cookie的域设置到主域，那么可以解决cookie污染的问题

针对中文站目前的情况，确实需要更换新的主域名，因为中文应该有部分的cookie并没有指定域，而是全局的